#cloud-config
package_update: true
package_upgrade: true
packages:
  - python3
  - python3-venv
  - python3-pip
  - git

users:
  - name: timeflow
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: true
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC+fCs0fpDU4+72v7Mj5KXQjFt+7PBuB9iMyWWXUSSqA3S4IZXCwpUw1FXbQIgeoP/FXRqj6F5WqLn3XYTiRjm1GdNYbIHvxOOHL1FtHBT+hNAY7wGTk65UksPUbot8hyc28jO3Ic+Ocse83eYDgdoXe5xnYF1UWb2MsGCtELZVsmabODDxUoE1QLu3JM6TvuC0Mi+JgCEqFEQGXx51lnKJ4HawgL5Kb5JocbYbxB/0q+gvQHqAEbGbxSORUvip0uB7AhEHOgoWiaezO3iXUniZGHcSxjyq4OhRVX+ewvFg9JRsOrPXbkGsFuVS3RS8HdJkCP5NfP6eAcOdyOZSO9OMO8N6I+FugWmamkqYgbcnN/K7jj6P9Ad7932gOs4rEgxok57URzt9DJF9vRQf/Qkm9srI0CgKSLtgcT5k8SV34I/0Gmt7GQhc2q84Q96LAwHTjrhxG4uG999jo20fSuRCckUxuMdH62CnP1nHlsAf8jVu0XP0M4pfLtKBiyYE7rMFFIcYxWaDO+9OnsFgBTxiQG3LTg6bRX6KCNXAEWiBTT9K9mzLobaN9Bg/VDZvs3jlX8XflrCTuZBOQuhAv/7YU3DU++vREWJJrwwZ7Tp1wFy9f/Z+lT+Kxvl4xXtprTBe1h7ajfdyfqAANnKWKbqHfUmLSGzZbeyoBs6pfd/+Kw== neonnear@mail.ru

write_files:
  - path: /etc/systemd/system/timeflow.service
    permissions: '0644'
    content: |
      [Unit]
      Description=TimeFlow Bot
      After=network-online.target
      Wants=network-online.target
      [Service]
      Type=simple
      User=timeflow
      WorkingDirectory=/opt/TimeFLow
      EnvironmentFile=/opt/TimeFLow/.env
      ExecStart=/opt/TimeFLow/venv/bin/python3 /opt/TimeFLow/main.py
      Restart=always
      RestartSec=5
      Environment=PYTHONUNBUFFERED=1
      [Install]
      WantedBy=multi-user.target
  - path: /etc/rc.local
    permissions: '0755'
    content: |
      #!/bin/bash
      if [ -s /opt/TimeFLow/.env ]; then
        systemctl restart timeflow
      fi
      exit 0

runcmd:
  - mkdir -p /opt/TimeFLow
  - chown -R timeflow:timeflow /opt/TimeFLow
  - sudo -u timeflow git clone https://github.com/neonnearjohn-dotcom/TimeFLow /opt/TimeFLow
  - cd /opt/TimeFLow && sudo -u timeflow python3 -m venv venv
  - cd /opt/TimeFLow && sudo -u timeflow /opt/TimeFLow/venv/bin/pip install --upgrade pip
  - cd /opt/TimeFLow && sudo -u timeflow /opt/TimeFLow/venv/bin/pip install -r requirements.txt
  - touch /opt/TimeFLow/.env
  - touch /opt/TimeFLow/service-account.json
  - chmod 600 /opt/TimeFLow/service-account.json
  - systemctl daemon-reload
  - systemctl enable timeflow
  - systemctl start timeflow
