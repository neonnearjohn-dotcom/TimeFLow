# Улучшенная генерация планов TimeFlow

## Обзор изменений

Реализована улучшенная персонализация планов с учетом всех параметров онбординга и динамическим горизонтом планирования.

## Основные улучшения

### 1. Новая система промптов
- **Файл**: `ai_prompts/plan_prompts.json`
- Детальные инструкции для GPT с примерами
- Поддержка различных категорий (exam, skill, habit, health, time)
- Few-shot примеры для улучшения качества
- Rectify промпт для исправления ошибок

### 2. Динамический горизонт планирования
- **Функция**: `calculate_horizon_days()` в `utils/plan_generator.py`
- Приоритеты:
  1. Дедлайн из ответов пользователя
  2. Явно указанное количество дней
  3. Автоматическая оценка по категории и уровню
- Адаптивные горизонты для разных категорий и уровней опыта

### 3. Валидация ограничений
- **Функция**: `validate_plan_constraints()` в `utils/plan_generator.py`
- Проверки:
  - Количество задач в день = sessions_per_day
  - Суммарное время задач ≤ daily_minutes
  - Время задач не позже no_study_after
  - Исключение blackout окон
- Автоматическое исправление через rectify-запрос

### 4. Учет всех параметров онбординга
- daily_minutes - лимит времени в день
- sessions_per_day - количество сессий/задач в день  
- no_study_after - запрет планировать после времени
- blackout - временные окна для исключения
- weekdays_only - только будние дни
- deadline - дедлайн для автоматического расчета горизонта
- level/current_level - уровень подготовки

## Как это работает

### Процесс генерации плана:

1. **Вычисление горизонта**:
   ```python
   horizon_days = calculate_horizon_days(answers, constraints, category)
   ```

2. **Загрузка промпта**:
   ```python
   prompt_config = await load_plan_prompt()  # из ai_prompts/plan_prompts.json
   ```

3. **Подготовка данных**:
   - Форматирование всех параметров
   - Подстановка в template_user
   - Добавление системного промпта

4. **Генерация через GPT**:
   ```python
   plan_json = await openai_assistant.generate_json_response(
       prompt=user_prompt,
       json_schema=plan_schema,
       system_prompt=system_prompt
   )
   ```

5. **Валидация и коррекция**:
   - Проверка ограничений
   - При ошибках - rectify запрос
   - Финальная валидация

6. **Преобразование в модель Plan**:
   ```python
   plan = await json_to_plan(plan_json, category, horizon_days)
   ```

## Примеры использования

### План с дедлайном:
```python
answers = {
    'goal': 'Подготовка к ЕГЭ',
    'deadline': '2024-06-15',
    'level': 'средний'
}
constraints = {
    'daily_minutes': 90,
    'sessions_per_day': 2,
    'no_study_after': '20:00',
    'blackout': ['12:00-13:00']
}
plan = await generate_plan('exam', answers, constraints)
```

### План с явным горизонтом:
```python
plan = await generate_plan(
    'skill', 
    answers={'goal': 'Гитара'}, 
    constraints={'daily_minutes': 60},
    horizon_days=21
)
```

## Критерии качества планов

✅ **Персонализация**: Учет всех ответов и предпочтений пользователя  
✅ **Прогрессия**: От простого к сложному с вариативностью  
✅ **Конкретика**: Детальные задачи, не общие фразы  
✅ **Контрольные точки**: Каждые 3-5 дней для оценки прогресса  
✅ **Соблюдение ограничений**: Время, количество сессий, blackout окна  
✅ **Адаптивность**: Разные подходы для разных категорий  

## Технические детали

### Поддерживаемые категории:
- `exam` - подготовка к экзаменам
- `skill` - развитие навыков
- `habit` - формирование привычек
- `health` - здоровье и фитнес
- `time` - тайм-менеджмент

### JSON схема плана:
```json
{
  "days": [
    {
      "day": 1,
      "tasks": [
        {"time": "09:00", "activity": "Конкретная задача"}
      ]
    }
  ]
}
```

### Совместимость:
- Полная обратная совместимость с существующей моделью PlanData
- Не требует изменений в FSM, UI или базе данных
- Работает как с OpenAI API, так и в детерминированном режиме

## Результаты тестирования

✅ Динамический горизонт работает корректно  
✅ Ограничения соблюдаются и валидируются  
✅ Планы персонализированы и конкретны  
✅ Контрольные точки добавляются автоматически  
✅ Rectify исправляет ошибки валидации  

## Дальнейшие улучшения

Возможные направления развития:
- Добавление адаптивной корректировки плана по ходу выполнения
- Учет обратной связи пользователя для улучшения следующих планов
- Интеграция с календарем для автоматического избежания занятого времени
- Добавление рекомендаций по оптимальному времени для разных типов задач
